---
version: 2.1

executors:
  ansible-lint:
    docker:
      - image: ghcr.io/docker-images-mamono210/circleci-executors/ansible-lint:latest
    resource_class: small
  yamllint:
    docker:
      - image: ghcr.io/docker-images-mamono210/circleci-executors/yamllint:latest
    resource_class: small
  trailing-whitespace:
    docker:
      - image: ghcr.io/docker-images-mamono210/circleci-executors/trailing-whitespace:latest
    resource_class: small

orbs:
  aws-cli: circleci/aws-cli@3.1.1
  molecule-ec2: orbss/molecule-ec2@0.0.4

jobs:
  ansible-lint:
    executor: ansible-lint
    steps:
      - checkout
      - run:
          name: Install galaxy roles
          command: |
            ansible-galaxy install -r roles/requirements.yml
      - run:
          name: Execulte Ansible-lint
          command: ansible-lint
      - run:
          name: Show Ansible-lint version
          command: |
            pip list | grep ansible \
            | GREP_COLORS='mt=01;34' egrep --color=always '[[:digit:]]' \
            | GREP_COLORS='mt=01;34' egrep --color=always '\.' \
            | GREP_COLORS='mt=01;33' egrep --color=always 'ansible.* '
            ansible-lint --version
  molecule-ec2:
    executor: molecule-ec2/default
    steps:
      - checkout
      - aws-cli/setup:
          profile-name: default
          role-arn: ${AWS_ROLE_ARN}
          role-session-name: molecule_redmine_create-backup
          session-duration: '3600'
      - run:
          name: Set required environment variables
          command: |
            echo "export AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}-molecule" >> $BASH_ENV
            echo "export AWS_S3_OBJECT_NAME=redmica/centos-stream8/${AWS_S3_OBJECT_NAME}" >> $BASH_ENV
            echo "export LOCAL_FILE_NAME=${AWS_S3_OBJECT_NAME}" >> $BASH_ENV
            source $BASH_ENV
      - molecule-ec2/execute:
          aws-ami-name: "redmica_restore_centos-stream8*"
          aws-ami-owner-id: "808683561341"
          aws-resource-name: "molecule_redmine_create-backup"
          aws-vpc-subnet-id: "subnet-022a704b3061b8b39"
          circleci-timeout: "15m"
        environment:
        # AWS_S3_BUCKET_NAME: stored in system environment variables
        # AWS_S3_OBJECT_NAME: stored in system environment variables
        # LOCAL_FILE_NAME: stored in system environment variables
  yamllint:
    executor: yamllint
    steps:
      - checkout
      - run:
          name: Execute yamllint
          command: find -type f -name "*.yml" | xargs yamllint
      - run:
          name: Show yamllint version
          command: |
            yamllint --version \
            | GREP_COLORS='mt=01;34' egrep --color=always '[[:digit:]]' \
            | GREP_COLORS='mt=01;34' egrep --color=always '\.' \
            | GREP_COLORS='mt=01;33' egrep --color=always 'yamllint.* '
  trailing-whitespace:
    executor: trailing-whitespace
    steps:
      - checkout
      - run:
          name: Execute trailing-whitespace
          command: trailing-whitespace

workflows:
  version: 2.1
  build:
    jobs:
      - trailing-whitespace
      - yamllint:
          requires:
            - trailing-whitespace
      - ansible-lint:
          requires:
            - yamllint
      - molecule-ec2:
          context: AWS_OPENID_CONNECT_TOKENS
          requires:
            - ansible-lint
